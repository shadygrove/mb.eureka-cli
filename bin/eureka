#!/usr/bin/env node

const program = require('commander');
const api = require('../');

// add example to help
program.on('--help', function(){
    api.log.info('');
    api.log.info('Examples:');
    api.log.info('  $ eureka tunnel my-space -j myjumpserve.com -e eureka.myhost.com -ep 8761 -lp 1234 -p key.pem');
    api.log.info('  $ eureka ls');
});

// handle unknown commands
program.on('command:*', function () {
    api.log.error('Invalid command: %s\nSee --help for a list of available commands.', program.args.join(' '));
    process.exit(1);
});

program
    .command('ls')
    .action(() => {
        api.log.info('eureka ls');
        api.eureka.apps()
            // .then((data) => {
            //     // api.log.info('data', JSON.stringify(data));
            // })
            .then(res => res.text())
            .then(json => console.log('JSON', json))
            .catch((err) => {
                console.log(err);
                api.log.error('FAILED', err);
            });
    });

program
    .command('tunnel')
    .description('Tunnel to a eureka instance')
    .option('-j, --jumpServer <jumpServer>', 'Jump server host/ip')
    .option('-e, --eurekaServer <eurekaServer>', 'Eureka server host/ip')
    .option('-ep, --eurekaPort <eurekaPort>', 'Eureka port')
    .option('-lp, --localPort <localPort>', 'Local port to forward')
    .option('-p, --pemFile <pemFile>', '.pem file location')
    .on('--help', function(){
        api.log.info('');
        api.log.info('Examples:');
        api.log.info('  $ eureka tunnel my-space -j myjumpserve.com -e eureka.myhost.com -ep 8761 -lp 1234 -p key.pem');
    })
    .action((options, cmd) => {
        if (!options.jumpServer
            && !options.eurekaServer
            && !options.eurekaPort
            && !options.localPort
            && !options.pemFile) {
                api.log.warn('all options required');
                cmd.outputHelp()
                return;
            }
        
        api.log.info('Opening tunnel...');

        api.tunnel.openTunnel(
            options.jumpServer, 
            options.eurekaServer, 
            options.localPort, 
            options.eurekaPort, 
            options.pemFile
        );

        process.on('exit', (code) => {
            api.log.warn('Exiting...', code);
            api.tunnel.closeTunnel();
        })
    });

program
    .parse(process.argv);
